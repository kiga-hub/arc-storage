# 机器声纹历史数据访问接口

## 目的

1. 从平台获取传感器历史数据
2. 上传传感器数据

## 主要流程

- 传感器ID信息列表
  - 获取平台所有传感器ID信息列表
- 获取传感器数据列表
  - 匹配传感器ID、采集时间范围、采样率等参数
  - 传感器数据列表接口
- 上传采集数据
  - 匹配传感器ID、采集时间范围、采样率等参数
  - 数据上传接口
- 下载传感器采集数据
  - 数据列表接口
  - 数据下载接口

## 接口整体设计

通讯协议采用 HTTP 1.1，服务的根路径为`/api`

### 公共请求消息头

获取数据信息接口及下载传感器数据接口的公共头域。

| 消息头（Header） | 是否必须 | 说明                            |
| ---------------- | -------- | -------------------------------|
| Content-Type     | 可选     | application/json; charset=utf-8 |

上传传感器数据接口头域

| 消息头（Header） | 是否必须 | 说明                            |
| ---------------- | -------- | -------------------------------|
| Content-Type     | 可选     | multipart/form-data; charset=utf-8 |


### 公共响应消息头

下表列出了所有声纹数据库接口的公共响应头域。HTTP 协议的标准响应头域不再这里列出。

| 消息头（Header） | 说明                                              |
| ---------------- | -------------------------------------------------|
| Content-Type     | 只支持 JSON 格式，application/json; charset=utf-8 |

### 公共响应状态码

| 代码 | 含义         |
| ---- | ------------ |
| 200  | 请求成功     |
| 201  | 创建成功     |
| 400  | 请求参数错误 |
| 401  | 未授权       |
| 403  | 请求被拒绝   |
| 404  | 资源未找到   |
| 500  | 服务内部异常 |

### 响应数据格式

数据响应统一为如下格式。其中错误码取值来源公共内部状态码和各方法的专有内部状态码。

后续各接口只分别列出请求结果结构和专有内部状态码。

| 参数名 | 类型   | 说明           |
| ------ | ------ | -------------- |
| code   | number | 内部状态码     |
| msg    | string | 错误编码及描述 |
| data   | Object | 本次请求的结果 |

### 公共内部状态码 TODO  

| 内部状态码 | 描述                                        |
| ---------- | ------------------------------------------- |
| 0          | 请求成功，结果保存在 data 字段中            |
| >0         | 错误编码，有错误发生，错误详情在 msg 字段中 |


## 数据项格式

### 数据请求(Query)

| 字段      | 说明           | 类型             | 取值范围          | 默认值 | 是否必须 |
| --------- | -------------- | ---------------- | ----------------- | ------ | --------|
| url       | 完整请求路径   | string           | http://...        |        | 是       |
| scheme    | 协议           | string           | http              |        | 是       |
| domain    | 域名           | string           | arc-storage |        |          |
| path      | 路径           | string           |api/data/v1/history|        | 是       |
| sensorid  | 传感器id       | string           |    sensorid       |        | 是       |
| type      | 数据类型       | string           | audio或vibrate    |        | 是       |
| timefrom | 时间范围起始值 | unix，精度到毫秒 |                   |        | 是       |
| timeto   | 时间范围结束值 | unix，精度到毫秒 |                   |        | 是       |


## 接口


### 数据列表接口

| 路径                    | 方法 | 描述 | 请求数据格式 | 结果数据格式 |
| ----------------------- | ---- | ---- | ------------ | ------------ |
|/data/v1/history/search | GET  | -    | -            | -            |

#### Query 参数

| 参数      | 是否必须 | 说明                               |
| --------- | -------- | ---------------------------------- |
| sensorid  | 是       | 传感器ID                           |
| type      | 是       | audio或vibrate                     |
| from | 是       | 查找数据的起始时间，unix精度到毫秒 |
| to   | 是       | 查找数据的起始时间，unix精度到毫秒 |

#### 响应结果数据格式

| 字段  | 说明             | 类型         | 取值范围 | 默认值 | 是否必须 |
| ----- | ---------------- | ------------ | -------- | ------ | -------- |
| items | 查找到的数据对象 | DataItem数组 | -        | -      | 是       |

举例

```json
{
  "code": 200,
  "msg": "OK",
  "items": [
    {
      "datatype": "audio",
      "samplerate": "48000",
      "channel": 1,
      "timefrom": 1640044980000,
      "timeto": 1640045040000,
      "timeduration": 60000,
      "datasize": 5760000,
      "query": {
        "url": "http://arc-storage/api/data/v1/history/arc?sensorid=A00000000004&type=audio&from=1640044980000&to=1640045040000",
        "scheme": "http",
        "domain": "arc-storage",
        "path": "api/data/v1/history/arc",
        "sensorid": "A00000000004",
        "type": "audio",
        "timefrom": 1640044980000,
        "timeto": 1640045040000
      }
    }
  ]
}
```

## TDEngine 内部测试接口

>[TDEngine说明文档](TDEngine说明文档.md)

### 获取振动值类型数据接口(X、Y、Z)

| 路径                 | 方法 | 描述 | 请求数据格式 | 结果数据格式 |
| -------------------- | ---- | ---- | ------------ | ------------ |
| /data/v1/history/vibrate | GET | -    | -            | DataItem     |

#### Query 参数

| 参数      | 是否必须 | 说明                               |
| --------- | -------- | ---------------------------------- |
| sensorids  | 是       | 传感器ID                           |
| from | 是     | 查找数据的起始时间，unix精度到毫秒 |
| to   | 是     | 查找数据的起始时间，unix精度到毫秒 |
| function | 否 | 默认first 、SQL通配符操作 |
| interval | 否 | 默认100ms 、时间聚合维度down sample 操作，默认时间100毫秒 |
| fill     | 否 | 默认PREV填充格式 (NONE- 不进行填充,NULL-使用NULL填充数据、PREV-使用前一个非NULL值填 |

- `Description`:
```bash
可选项说明: SQL查询使用函数(聚合函数、选择函数、计算函数、按窗口切分聚合等)。
不使用可选项，则输出查询到的所有数据。
function - 单个输出选择函数,推荐first, 参数：avg,sum,min,max,first,last。
interval - 聚合时间段的窗口,interval指定，最短时间间隔10毫秒(10a),推荐100ms。
fill     - 指定某一窗口区间数据缺失的情况下的填充模式,推荐使用PREV,详细查看文档。
```

### 获取温度值类型数据接口(X、Y、Z)

获取温度值数据

| 路径                 | 方法 | 描述 | 请求数据格式 | 结果数据格式 |
| -------------------- | ---- | ---- | ------------ | ------------ |
| /data/v1/history/temperature | GET | -    | -            | DataItem     |


#### Query 参数

| 参数      | 是否必须 | 说明                               |
| --------- | -------- | ---------------------------------- |
| sensorids  | 是       | 传感器ID                           |
| from | 是     | 查找数据的起始时间，unix精度到毫秒 |
| to   | 是     | 查找数据的起始时间，unix精度到毫秒 |
| function | 否 | 默认first 、SQL通配符操作 |
| interval | 否 | 默认100ms 、时间聚合维度down sample 操作，默认时间100毫秒 |
| fill     | 否 | 默认PREV填充格式 (NONE- 不进行填充,NULL-使用NULL填充数据、PREV-使用前一个非NULL值填 |

描述同上

#### 响应结果数据格式

| 字段  | 说明             | 类型         | 取值范围 | 默认值 | 是否必须 |
| ----- | ---------------- | ------------ | -------- | ------ | -------- |
| data | 查找到的数据对象 | DataItem数组 | -        | -      | 是       |

举例

```json
{
  "code": 200,
  "msg": "OK",
  "data": [
    {
      "collectorid": "A00000000001",
      "count": 1,
      "data": [
        {
          "Time": "2021-08-16 07:33:12.000522",
          "Temperature": 45.19126
        }
      ]
    },
    {
      "collectorid": "A00000000002",
      "count": 1,
      "data": [
        {
          "Time": "2021-08-16 07:33:12.001421",
          "Temperature": 64.42809
        }
      ]
    }
  ]
}
```


# Export & Import Data(内部使用) 

## TDEngine 导入数据

| 路径                 | 方法 | 描述 | 请求数据格式 | 结果数据格式 |
| -------------------- | ---- | ---- | ------------ | ------------ |
| /data/v1/history/dataimport | PUT  | -    | -            |  -   |

#### Query 参数

| 参数      | 是否必须 | 说明                               |
| --------- | -------- | ---------------------------------- |
| path  | 是       | 导入路径                          |
| tythreadnumpe      | 否       | 导入数据时启动的线程数，默认5    |

举例

```json
{
  "Process":"Done", 
}
```

## TDEngine 定时备份数据

| 路径                 | 方法 | 描述 | 请求数据格式 | 结果数据格式 |
| -------------------- | ---- | ---- | ------------ | ------------ |
| /data/v1/history/startbackups | POST  | -    | -            | -   |


#### Query 参数

| 参数      | 是否必须 | 说明                               |
| --------- | -------- | ---------------------------------- |
| databasepath  | 是       | 磁盘挂载路径-数据库备份路径                         |
| backuppath    | 是       | 磁盘挂载路径-同步备份文件路径    |
| starttime    | 是       | 开始备份时间,从该开始时间开始备份    |
| stoptime    | 是       | 结束备份时间，备份到该时间为止，否则以当前时间为结束备份时间    |
| duration    | 是       | 异步备份涛思数据库间隔，默认24(24h为间隔导出一次数据库)    |
| tablebathch    | 否       | 指定导入到一个文件的表的个数,控制输出文件的大小,默认配置10    |
| threadnum    | 否       | 指定导入数据时，启动的线程数,默认5    |
| databatch    | 是       | 定一条import语句中包含记录的条数,该参数为了后续导入时，提高导入速率,默认配置5    |

举例

```json
{
  "Process":"Done", 
}
```

## TDEngine 停止备份数据

| 路径                 | 方法 | 描述 | 请求数据格式 | 结果数据格式 |
| -------------------- | ---- | ---- | ------------ | ------------ |
| /data/v1/history/stopbackups | POST  | -    | -            | -   |

#### Query 参数

- 无

举例

```json
{
  "Process":"Done", 
}
```