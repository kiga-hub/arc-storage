# 生产环境平台数据生命周期管理

> 数据中心 -（Lab） 
- 数据中心处理数据迁移后的数据,将从工厂迁移出的数据进行抽取 、分析应用。
```bash
#取回数据  ->    训练   -> 删除
Migration -> Training  -> Delete
```

> 数据节点 - 工厂私有云环境
- 一个工厂包含多个数据节点,一个节点对应一个机组,每个节点拥有各自的数据生命周期。

采集数据在`数据节点`的生命周期
```bash
#采集  ->     转发   -> 存储  -> ----> 访问/迁移  -> 过时删除
Device ->  Receiver -> arc-storage -> |---> Data Access 
                                |---> Migration -> Delete
```


----------------------------------------------------------------

## 一. 数据生命周期阶段

### 数据节点-数据生命周期包含以下阶段

1. 采集设备数据
 - 数据接收服务`Receiver`使用`gnet`接收采集的数据
2. 原始数据传输
 - 数据从`Kafka`队列按序消费,或者使用`gRPC`服务进行传输。
3. 数据存储
 - 音频、振动源数据将保存为文件类型(`wav`)
 - 解析&计算振动、温度值数据存储至时序数据库(`TDEngine`)
4. 数据抽取、分析应用
 - `RESTful API` 接口查询历史数据,`websocket`查询实时数据
5. 数据迁移、备份、拷贝
 - 服务定时导出数据库数据
 - 脚本拷贝数据
6. 数据过时删除
 - 确定数据迁移方案后,选择对应的删除策略

### 数据中心-数据生命周期各个阶段

1. 数据分类
- 音频
- 振动
2. 数据分析
- 训练模型
3. 数据删除
- 使用机器学习训练模型后删除

----------------------------------------------------------------

## 二. 影响数据生命周期管理方案的因素

### 数据

#### 1. 原始数据
- 音频、振动、温度等未经处理的原始数据

#### 2. 文件
- 数据类型:音频、振动
- 文件格式:wav、pcm、gzip
- 数据属性:声音采样率32k、48k,振动采样率3.2K
- 数据颗粒度:一个采集设备对应一个ID,数据落盘间隔为1分钟
- 存储大小: Audio:5.6MB(48K),Vibrate:1.2MB(3.2K)

> 设备数 & 数据量(不包括平台基础支持数据)

| 设备数 | 时间   | 数据量(声音48K、振动3.2K)   | 文件个数(A+V)  |
| :----- | :----- | :-------------------------- | :------------- |
| 1      | 24h    | 8064MB + 2304MB = 10.368 GB | 2x60x24=2880个 |
| 1      | 1month | 311    GB                   | 8.64  万个     |
| 40     | 1month | 12.44  TB                   | 345.6 万个     |

> 测点数 & 存储时长

|  时长   |  40测点  |  80测点  | 160测点  |
| :-----: | :------: | :------: | :------: |
| 1month  | 12.44TB  | 24.88TB  | 49.76TB  |
| 3month  | 37.32TB  | 74.64TB  | 149.28TB |
| 5month  |  62.2TB  | 124.4TB  | 248.8TB  |
| 6monnth | 74.64TB  | 149.28TB | 298.56TB |
|  1year  | 149.28TB | 298.56TB | 597.12TB |

### 3. 时序数据
- 使用TDEngine保存所有时序型数据
- 振动值数据
- 温度值数据
- 解包及其他实时处理数据信息
- 记录数据迁移的时间

### 4. 容器日志
- 所有Docker服务输出的日志

### 5. 系统日志
- 硬件信息
- 软件信息
- 系统问题信息

### 6. 应用日志
- 程序执行过程输出日志(INFO、DEBUG、ERROR)

### 7. 度量数据
- Prometheus

### 8. 链路分析
- Tracing

### 9. 备份数据
- 同步写入的文件
- 数据库导出的文件

### 硬件

#### U盘
- 硬件类型:U
- 尺寸:90×54mm
- 容量:128G、256G、512G、1T
- 读写速度:15-80M/s

#### 外置磁盘阵列
- 硬件类型:机械硬盘
- 接口:USB3.0
- 转速:5400rpm、7200rpm
- 尺寸:3.5寸
- 容量:2盘位,32TB,RAID JBOD
- 读写速度:文件未使用脚本打包情况(40～60MB/s),用脚本打包后传输速率(150~300MB/s)。

#### 主机存储(刀片机热插拔硬盘)
- 硬件类型:机械硬盘
- 接口:Sata3.0/SAS
- 转速:5400rpm、7200rpm
- 尺寸:3.5寸
- 容量:3盘位以上为一组,每组48TB,做软RAID5 = (n-1)*16 TB,n = 硬盘个数
- 读写速度:突发速率600MB/s,平均速率-待实测

#### 独立存储服务器
- 待定

#### 云存储
- Storage Cloud Service(OSS)

### 其他因素

#### 资源成本(资金、设备、时间、人力)
- 物理距离考量(部署现场-公司路程)
- 数据迁移周期(取回数据-天、月、年为单位)
- 数据迁移耗时(拷贝时间)
- 资金

#### 不可抗力因素
- 设备运输途中,发生磕碰导致数据丢失
- 数据迁移出现错误或失败

----------------------------------------------------------------

## 三. 具体可选方案

### Solution A

>硬件选择
- 使用外置磁盘阵列,USB3.0接口进行数据迁移

>数据生命周期

| 数据生命周期      |   原始数据A    | 文件B | 时序数据C |   容器数据D    |  系统日志E   |    应用日志F     |   度量数据G    |  链路分析H  |  备份数据I   |
| :---------------- | :------------: | :---: | :-------- | :------------: | :----------: | :--------------: | :------------: | :---------: | :----------: |
| 采集设备发送数据1 | 数据块定义格式 |   X   | X         | Docker容器日志 | 各种系统日志 | 平台各个应用日志 | Prometheus日志 | tracing日志 | 迁移出的数据 |
| 数据转发2         |       A2       |   X   | C2        |      BSD       |     BSD      |       BSD        |      BSD       |     BSD     |      X       |
| 数据存储3         |       X        |  B3   | C3        |      BSD       |     BSD      |       BSD        |      BSD       |     BSD     |      X       |
| 数据迁移4:周期N   |       X        |  B4   | C4        |      Move      |     Move     |       Move       |      Move      |    Move     |   Move/I4    |
| 数据清理5:范围M   |       X        | Clean | Clean     |     Clean      |    Clean     |      Clean       |     Clean      |    Clean    |   Clean/I5   |

- X: 代表无相关属性,或不存在此类数据
- A2: 使用`kafka`队列或者`gRPC`进行数据传输(数据块)

- B3: 数据管理服务反序列化解析后的数据。存储目录为Cephfs文件系统的子目录
- B4: 增量拷贝至外置硬盘(mount /dev/sdc  /mydata/data)

- C2: 解析数据包,计算振动、温度值数据,解析包个数、处理数据量等,实时存入时序数据库`TDEngine`。
- C3: 记录每分钟处理的音频或振动的数据包个数,并保存至时序数据库`TDEngine`
- C4: taosdump导出一定时间范围内的数据库内所有数据,导出的文件格式为.sql

- BSD: Basic Supporting Data 基础支持数据,保存至主机存储中(`Cephfs`)
- Move: 使用脚本拷贝所有相关日志到外置磁盘阵列(mount: /dev/sdc /mydata/data)
- Clean: 数据有效性验证(`MD5`),无效则重复迁移流程。读取数据库记录的迁移起始时间,计算清理时间范围`T`,从主存(`Cephfs`)中删除,结束`T`周期

>备份数据生命周期
- I4: 备份数据的生命周期不同于`数据节点`,该生命周期是从`数据节点`拷贝数据开始
- I5: 数据迁往`数据中心`后,数据校验、进行分析、训练模型、删除数据,结束生命周期。

>数据迁移
- 每次迁移数据的时间记为1个周期,时长为N,周期单位N:天、月、年。
- N = 数据拷贝、数据库导出、脚本拷贝日志以及更换外置硬盘的时间。

>数据清理
```bash
-----------|——————————|————————|——————————|———————>
4N        3N         2N        N         Now    Runing
```
- Now: 开始迁移日期,迁移数据的时间范围为N-Now 
- N~Now: 要迁移的数据范围
- 3N-N: 为预留时长
- 数据保留时长M = N+2或3N,清理3N之前的所有数据

### Solution B

>硬件选择
- 主机存储(热插拔硬盘,以下简称硬盘)

>数据生命周期

| 数据生命周期      |   原始数据A    | 文件B | 时序数据C |   容器数据D    |  系统日志E   |    应用日志F     |   度量数据G    |  链路分析H  |  备份数据I   |
| :---------------- | :------------: | :---: | :-------- | :------------: | :----------: | :--------------: | :------------: | :---------: | :----------: |
| 采集设备发送数据1 | 数据块定义格式 |   X   | X         | Docker容器日志 | 各种系统日志 | 平台各个应用日志 | Prometheus日志 | tracing日志 | 迁移出的数据 |
| 数据转发2         |       A2       |   X   | C2        |      BSD       |     BSD      |       BSD        |      BSD       |     BSD     |      X       |
| 数据存储3         |       X        |  B3   | C3        |      BSD       |     BSD      |       BSD        |      BSD       |     BSD     |      X       |
| 数据迁移4:周期N   |       X        |  B4   | C4        |      Move      |     Move     |       Move       |      Move      |    Move     |   Move/I4    |
| 数据清理5:范围M   |       X        | Clean | Clean     |     Clean      |    Clean     |      Clean       |     Clean      |    Clean    |   Clean/I5   |

- X: 代表无相关属性,或不存在此类数据
- A2: 使用`kafka`队列或者`gRPC`进行数据传输(数据块)

- B3: 数据管理服务反序列化解析后的数据文件格式。
- B4: 迁移部分为更换硬盘时生成的文件,即遗漏的备份文件,使用增量拷贝方式拷贝至硬盘中,路径同上

- C2: 解析数据包,计算振动、温度值数据,解析包个数、处理数据量等,实时保存至时序数据库`TDEngine`
- C3: 记录每分钟处理的音频或振动的数据包个数,并保存至时序数据库`TDEngine`
- C4: taosdump导出一定时间范围内的数据库内所有数据,导出的文件格式为.sql,使用脚本拷贝导出文件至硬盘中

- BSD: Basic Supporting Data 基础支持数据,保存至主机存储中(`Cephfs`)
- Move: 使用脚本拷贝所有相关日志到硬盘(设备挂载路径)
- Clean: 数据有效性验证(`MD5`),无效则重复迁移流程。读取数据库记录的迁移起始时间,计算清理时间范围`T`,从主存(`Cephfs`)中删除,结束`T`周期

>备份数据生命周期
- I4: 备份数据的生命周期不同于`数据节点`,该生命周期是从`数据节点`拷贝数据开始
- I5: 数据迁往`数据中心`,进行分析、训练模型、删除硬盘中数据,结束生命周期。

>数据迁移
- 每次迁移数据的时间记为1个周期,时长为N。周期单位N:天、月

>数据清理
```bash
------------|——————————|—————————|—————————>
3N         2N          N        Now    Runing
```
- Now: 开始迁移的当前时间
- N-NoW：迁移数据的时间范围
- 2N-N: 上一次数据迁移时间范围
- 数据保留时长M = N+1或2N,清理2N之前的所有数据

----------------------------------------------------------------


## 六. 术语

- 增量拷贝:仅拷贝有变动的文件部分,从上一次拷贝结束的时间-当前时间。

- 同步写入: 同一线程执行保存文件,按顺序数据将被复制成完全相同的两份,写入文件的时间戳一致。

- RAID:磁盘阵列(Redundant Arrays of Independent Disks,RAID) https://baike.baidu.com/item/%E7%A3%81%E7%9B%98%E9%98%B5%E5%88%97/1149823?fromtitle=RAID&fromid=33858 

- rpm:硬盘转速,以每分钟多少转来表示。单位表示为RPM,RPM是Revolutions per minute的缩写,是转/每分钟。RPM值越大,内部传输率就越快,访问时间就越短,硬盘的整体性能也就越好。

- USB3.0 :Universal Serial Bus(通用串行总线)。USB 3.0是一种USB规范,USB2.0的最大传输带宽为480Mbps（即60MB/s）,而USB3.0的最大传输带宽高达5.0Gbps（500MB/s）。

- Sata3:SerialATA Revision3.0 specificationv(串行ATA规格第三版)。6Gbps(750MB/s)只是理论值,事实上SATA接口发送信息的速度为600MB/s,而受制于系统各部件的影响,实际速度会更低一些,而且不同环境差异会很大。

- TDEngine: 全栈时序数据处理引擎。https://www.taosdata.com/cn/documentation/

- taosdump: TDEngine数据导入导出工具。

- OSS:云对象存储(Object Storage Service)。与平台无关的RESTful API接口,可以在任何应用、任何时间、任何地点存储和访问任意类型的数据。

- 异步拷贝(复制)：所有在主存中的数据,拷贝到另一个硬盘中。如果发生失效,第一个服务器的硬盘上的被提交数据可能会丢失。

- 突发速率:(接口传输率,外部数据传输率),数据最高传输率。

- 备份:备份的意思就是不仅可以把重要文件COPY复制文件，也可以做成一个压缩或其它格式文件，许多文件也可以备份成一个文件。

- Cephfs:优秀的性能、可靠性和可扩展性而设计的统一的、分布式文件系统。支持块存储、文件存储、对象存储。
  